# .htaccess - AliveChMS API
# Secure and clean URL routing with CDN support

# Prevent directory listing
Options -Indexes

# Enable rewrite engine
RewriteEngine On

# Block access to sensitive files
RewriteRule ^(\.env|\.git|composer\.json|composer\.lock|vendor/|logs/|core/|routes/) - [F,L,NC]

# Block common malicious patterns
RewriteCond %{QUERY_STRING} (\.\.\/|\.\.%2f|%2e%2e%2f|%252e%252e%252f|~|\^|`|\[|\]|\.\.\/) [NC]
RewriteRule .* - [F,L]

# Route all requests to index.php (except existing files/directories)
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php?path=$1 [QSA,L]

# Security headers
<IfModule mod_headers.c>
    # Basic security headers
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Updated Content-Security-Policy to allow CDN resources
    # This allows Bootstrap, Chart.js, SweetAlert2, DataTables, etc. from trusted CDNs
    Header always set Content-Security-Policy "\
        default-src 'self'; \
        script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.jsdelivr.net  https://cdnjs.cloudflare.com; \
        style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://fonts.googleapis.com; \
        font-src 'self' data: https://cdn.jsdelivr.net https://fonts.gstatic.com; \
        img-src 'self' data: https:; \
        connect-src 'self' https://cdn.jsdelivr.net; \
        frame-ancestors 'none'; \
        base-uri 'self'; \
        form-action 'self'"
</IfModule>

# Disable server signature
ServerSignature Off
